<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Generar Turno — DigiTurno</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    :root { --pri: #E2072D; --acc: #FAB52D; --bg: #f4f5f7; --card: #fff; --txt: #1a1a2e; --muted: #6b7280; --bdr: #e5e7eb; }
    body { background: var(--bg); min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 1rem; }
    .app { background: var(--card); border-radius: 28px; padding: clamp(1.25rem,4vw,2rem); width: min(100%, 540px); min-height: min(96vh, 820px); display: flex; flex-direction: column; box-shadow: 0 12px 40px rgba(0,0,0,0.08); position: relative; }

    /* Bell */
    .bell-btn { position: absolute; top: 1.25rem; right: 1.25rem; width: 44px; height: 44px; border-radius: 50%; background: var(--bg); border: 1.5px solid var(--bdr); cursor: pointer; display: none; align-items: center; justify-content: center; z-index: 50; }
    .bell-btn svg { width: 22px; height: 22px; stroke: var(--txt); stroke-width: 2; fill: none; }
    .bell-btn .bell-count { position: absolute; top: -4px; right: -4px; background: var(--pri); color: #fff; font-size: 0.65rem; font-weight: 700; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .bell-btn.has-notifs { display: flex; }

    /* Notification Panel */
    .notif-panel { position: absolute; top: 4.5rem; right: 1rem; width: 280px; background: var(--card); border-radius: 16px; box-shadow: 0 12px 40px rgba(0,0,0,0.15); z-index: 100; max-height: 320px; overflow-y: auto; display: none; border: 1px solid var(--bdr); }
    .notif-panel.open { display: block; }
    .notif-item { padding: 0.75rem 1rem; border-bottom: 1px solid var(--bdr); font-size: 0.85rem; }
    .notif-item:last-child { border-bottom: none; }
    .notif-item.urgent { background: #fef2f2; color: var(--pri); font-weight: 600; }
    .notif-item .notif-time { font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem; }

    .header { margin-bottom: 1rem; }
    .header h1 { color: var(--pri); font-size: 1.8rem; font-weight: 700; }
    .header .sede-name { font-size: 0.9rem; color: var(--muted); margin-top: 0.25rem; }
    .progress { display: flex; gap: 6px; margin-top: 0.75rem; }
    .dot { flex: 1; height: 5px; background: var(--bdr); border-radius: 4px; transition: background 0.3s; }
    .dot.active { background: var(--pri); }
    .dot.done { background: var(--acc); }

    .sections { flex: 1; overflow-y: auto; scrollbar-width: none; min-height: 0; }
    .sections::-webkit-scrollbar { display: none; }
    .section { display: none; animation: fadeUp 0.25s ease; }
    .section.active { display: flex; flex-direction: column; height: 100%; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .section-title { font-size: 1.15rem; font-weight: 600; margin-bottom: 1rem; color: var(--txt); }

    /* Priority grid */
    .prio-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 0.75rem; flex: 1; align-content: center; }
    .prio-item { background: var(--bg); border: 2px solid var(--bdr); border-radius: 20px; padding: 1.5rem 0.75rem; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
    .prio-item.selected { background: var(--pri); border-color: var(--pri); }
    .prio-item.selected .prio-label { color: #fff; }
    .prio-item svg { width: 36px; height: 36px; stroke: var(--pri); stroke-width: 2; fill: none; transition: stroke 0.2s; }
    .prio-item.selected svg { stroke: #fff; }
    .prio-label { font-size: 0.85rem; font-weight: 600; color: var(--txt); }

    /* Services grid */
    .svc-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 0.6rem; flex: 1; align-content: start; }
    .svc-card { background: var(--bg); border: 2px solid var(--bdr); border-radius: 16px; padding: 1rem 0.5rem; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 0.4rem; min-height: 90px; justify-content: center; }
    .svc-card.selected { background: var(--pri); border-color: var(--pri); }
    .svc-card.selected .svc-name { color: #fff; }
    .svc-card svg { width: 28px; height: 28px; stroke: var(--pri); stroke-width: 2; fill: none; transition: stroke 0.2s; }
    .svc-card.selected svg { stroke: #fff; }
    .svc-name { font-size: 0.75rem; font-weight: 600; color: var(--txt); line-height: 1.2; word-break: break-word; }

    /* Form */
    .form-wrap { background: var(--bg); border-radius: 20px; padding: 1.25rem; }
    .field { margin-bottom: 1rem; }
    .field:last-child { margin-bottom: 0; }
    .field label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.35rem; }
    .field input { width: 100%; padding: 0.75rem 1rem; background: var(--card); border: 1.5px solid var(--bdr); border-radius: 12px; font-size: 1rem; }
    .field input:focus { outline: none; border-color: var(--pri); }

    /* Summary */
    .summary { background: var(--bg); border-radius: 20px; padding: 1.5rem; text-align: center; }
    .summary .s-svc { color: var(--pri); font-size: 1.3rem; font-weight: 700; margin-bottom: 0.5rem; }
    .summary .s-prio { display: inline-block; background: var(--acc); color: #fff; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.75rem; }
    .summary .s-name { font-size: 1.05rem; font-weight: 600; }
    .summary .s-doc { font-size: 0.9rem; color: var(--muted); }

    /* Ticket */
    .ticket { background: var(--bg); border-radius: 24px; padding: 2rem 1.5rem; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .ticket-check svg { width: 56px; height: 56px; stroke: var(--acc); stroke-width: 2.5; fill: none; margin-bottom: 1rem; }
    .ticket-label { font-size: 0.85rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
    .ticket-num { color: var(--pri); font-size: clamp(2.5rem,12vw,4.5rem); font-weight: 800; line-height: 1; margin: 0.5rem 0; }
    .ticket-svc { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
    .ticket-meta { font-size: 0.9rem; color: var(--muted); margin-bottom: 0.25rem; }
    .ticket-wait { background: var(--acc); color: #fff; padding: 0.75rem; border-radius: 16px; font-size: 1rem; font-weight: 600; margin: 1rem 0; }
    .ticket-pos { font-size: 0.85rem; color: var(--muted); }

    .nav-btns { display: flex; gap: 0.75rem; margin-top: auto; padding-top: 1rem; }
    .nb { flex: 1; padding: 0.85rem; border: none; border-radius: 14px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    .nb:active { transform: scale(0.97); }
    .nb-pri { background: var(--pri); color: #fff; }
    .nb-sec { background: transparent; color: var(--pri); border: 2px solid var(--pri); }
    .nb-new { background: var(--pri); color: #fff; width: 100%; margin-top: 1rem; padding: 1rem; border: none; border-radius: 14px; font-size: 1.05rem; font-weight: 700; cursor: pointer; }

    .loading-msg { text-align: center; padding: 2rem; color: var(--muted); }
    .sede-selector { text-align: center; padding: 2rem 1rem; }
    .sede-selector h2 { margin-bottom: 1rem; color: var(--pri); }
    .sede-list { display: grid; gap: 0.75rem; }
    .sede-option { padding: 1rem; background: var(--bg); border: 2px solid var(--bdr); border-radius: 14px; cursor: pointer; font-weight: 600; transition: all 0.2s; text-align: left; }
    .sede-option:hover { border-color: var(--pri); }
    .sede-option .sede-dir { font-size: 0.8rem; color: var(--muted); font-weight: 400; margin-top: 0.25rem; }
    @media (max-width: 400px) { .svc-grid { grid-template-columns: repeat(2,1fr); } }
  </style>
</head>
<body>
<div class="app">
  <button class="bell-btn" id="bellBtn" onclick="toggleNotifPanel()">
    <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
    <span class="bell-count" id="bellCount">0</span>
  </button>
  <div class="notif-panel" id="notifPanel"></div>

  <div id="sedeSelect" class="sede-selector" style="display:none;">
    <h2>Selecciona una sede</h2>
    <div class="sede-list" id="sedeList"></div>
  </div>

  <div id="mainApp" style="display:none; flex-direction:column;">
    <div class="header">
      <h1>DigiTurno</h1>
      <div class="sede-name" id="sedeName"></div>
      <div class="progress" id="progress">
        <div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
    </div>
    <div class="sections">
      <div class="section active" id="step1">
        <div class="section-title">Tipo de atencion</div>
        <div class="prio-grid">
          <div class="prio-item" onclick="selPrio('discapacidad')" id="p-disc">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="4" r="2"/><path d="M12 6v6m-4 4h8l-2-4H10l-2 4"/><circle cx="9" cy="20" r="2"/><circle cx="15" cy="20" r="2"/></svg>
            <span class="prio-label">Discapacidad</span>
          </div>
          <div class="prio-item" onclick="selPrio('embarazo')" id="p-emb">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="6" r="3"/><path d="M9 12c0 4 2 8 3 9s3-5 3-9"/></svg>
            <span class="prio-label">Embarazo</span>
          </div>
          <div class="prio-item" onclick="selPrio('adulto_mayor')" id="p-adult">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="5" r="3"/><path d="M8 22l2-8h4l2 8M10 12h4"/></svg>
            <span class="prio-label">Adulto mayor</span>
          </div>
          <div class="prio-item selected" onclick="selPrio('ninguna')" id="p-none">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8"/><circle cx="12" cy="12" r="2" fill="currentColor"/></svg>
            <span class="prio-label">General</span>
          </div>
        </div>
      </div>
      <div class="section" id="step2">
        <div class="section-title">Elige tu tramite</div>
        <div id="loadingSvc" class="loading-msg">Cargando servicios...</div>
        <div class="svc-grid" id="svcGrid"></div>
        <div class="nav-btns"><button class="nb nb-sec" onclick="prev()">Atras</button><button class="nb nb-pri" onclick="next()">Continuar</button></div>
      </div>
      <div class="section" id="step3">
        <div class="section-title">Tus datos</div>
        <div class="form-wrap">
          <div class="field"><label>Nombre</label><input type="text" id="fNombre" placeholder="Ej: Juan Perez"></div>
          <div class="field"><label>Cedula</label><input type="text" id="fCedula" placeholder="12345678"></div>
          <div class="field"><label>Telefono</label><input type="tel" id="fTelefono" placeholder="3001234567"></div>
        </div>
        <div class="nav-btns"><button class="nb nb-sec" onclick="prev()">Atras</button><button class="nb nb-pri" onclick="next()">Continuar</button></div>
      </div>
      <div class="section" id="step4">
        <div class="section-title">Confirmar</div>
        <div class="summary" id="summary">
          <div class="s-svc" id="sumSvc">-</div>
          <div class="s-prio" id="sumPrio">General</div>
          <div class="s-name" id="sumName">-</div>
          <div class="s-doc" id="sumDoc">-</div>
        </div>
        <div class="nav-btns"><button class="nb nb-sec" onclick="prev()">Atras</button><button class="nb nb-pri" onclick="generar()">Generar turno</button></div>
      </div>
      <div class="section" id="step5">
        <div class="ticket">
          <svg viewBox="0 0 24 24" class="ticket-check"><circle cx="12" cy="12" r="10"/><path d="M8 12l3 3 5-5"/></svg>
          <div class="ticket-label">Tu turno</div>
          <div class="ticket-num" id="tNum">-</div>
          <div class="ticket-svc" id="tSvc"></div>
          <div class="ticket-meta" id="tNombre"></div>
          <div class="ticket-meta" id="tCedula"></div>
          <div class="ticket-wait" id="tWait">Espera estimada: -- min</div>
          <div class="ticket-pos" id="tPos"></div>
          <button class="nb-new" onclick="resetApp()">Generar otro turno</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="main.js"></script>
<script>
const PRIO_LABELS = { discapacidad:'Discapacidad', embarazo:'Embarazo', adulto_mayor:'Adulto mayor', ninguna:'General' };
let step=1, prioridad='ninguna', svcSeleccionado=null, serviciosData=[], sedeId=null, sedeName='', turnoId=null;
let notifs=[], pollTimer=null, prevPos=null;

(async function init(){
  const params = new URLSearchParams(location.search);
  const sedeParam = params.get('sede');
  if (sedeParam) {
    try {
      const { sede } = await DigiturnoAPI.buscarSede(sedeParam);
      sedeId = sede.ROWID; sedeName = sede.nombre;
      showApp();
    } catch(e) { showSedeSelector(); }
  } else { showSedeSelector(); }
})();

async function showSedeSelector(){
  document.getElementById('sedeSelect').style.display='block';
  document.getElementById('mainApp').style.display='none';
  try {
    const { sedes } = await DigiturnoAPI.listarSedes();
    const activas = sedes.filter(s=>s.activo);
    document.getElementById('sedeList').innerHTML = activas.length === 0
      ? '<p style="color:var(--muted)">No hay sedes disponibles</p>'
      : activas.map(s=>`<div class="sede-option" onclick="pickSede('${s.ROWID}','${s.nombre}')"><div>${s.nombre}</div><div class="sede-dir">${s.direccion||''}</div></div>`).join('');
  } catch(e) { document.getElementById('sedeList').innerHTML='<p style="color:red">Error cargando sedes</p>'; }
}

function pickSede(id, nombre){ sedeId=id; sedeName=nombre; showApp(); }

function showApp(){
  document.getElementById('sedeSelect').style.display='none';
  const ma = document.getElementById('mainApp');
  ma.style.display='flex';
  document.getElementById('sedeName').textContent = sedeName;
  loadSvcs();
}

async function loadSvcs(){
  document.getElementById('loadingSvc').style.display='block';
  try {
    const { servicios } = await DigiturnoAPI.listarServicios();
    serviciosData = servicios.filter(s=>s.activo!==false).map(s=>({id:s.ROWID, nombre:s.nombre||'Servicio'}));
    renderSvcs();
  } catch(e) { document.getElementById('svcGrid').innerHTML='<p style="grid-column:1/-1;text-align:center;color:var(--muted)">Error cargando servicios</p>'; }
  document.getElementById('loadingSvc').style.display='none';
}

function renderSvcs(){
  const g = document.getElementById('svcGrid');
  g.innerHTML = serviciosData.map(s=>`<div class="svc-card ${svcSeleccionado&&svcSeleccionado.id===s.id?'selected':''}" onclick="pickSvc('${s.id}')"><svg viewBox="0 0 24 24"><rect x="6" y="4" width="12" height="16" rx="1"/><path d="M10 8h4M10 12h4M10 16h2"/></svg><span class="svc-name">${s.nombre}</span></div>`).join('');
}

function pickSvc(id){ svcSeleccionado = serviciosData.find(s=>s.id===id); renderSvcs(); }

function selPrio(p){
  prioridad = p;
  document.querySelectorAll('.prio-item').forEach(el=>el.classList.remove('selected'));
  const map = {discapacidad:'p-disc',embarazo:'p-emb',adulto_mayor:'p-adult',ninguna:'p-none'};
  document.getElementById(map[p]).classList.add('selected');
  setTimeout(()=>next(), 250);
}

function next(){
  if(step===2 && !svcSeleccionado){ alert('Selecciona un tramite'); return; }
  if(step===3){
    if(!document.getElementById('fNombre').value.trim()||!document.getElementById('fCedula').value.trim()||!document.getElementById('fTelefono').value.trim()){ alert('Completa todos los campos'); return; }
    document.getElementById('sumSvc').textContent = svcSeleccionado.nombre;
    document.getElementById('sumPrio').textContent = PRIO_LABELS[prioridad];
    document.getElementById('sumName').textContent = document.getElementById('fNombre').value;
    document.getElementById('sumDoc').textContent = 'Cedula: '+document.getElementById('fCedula').value;
  }
  if(step<4){ goStep(step+1); }
}

function prev(){ if(step>1) goStep(step-1); }

function goStep(n){
  document.getElementById('step'+step).classList.remove('active');
  const dots = document.querySelectorAll('.dot');
  dots[step-1].classList.remove('active');
  if(n > step) dots[step-1].classList.add('done'); else dots[step-1].classList.remove('done');
  step = n;
  document.getElementById('step'+step).classList.add('active');
  dots[step-1].classList.add('active');
  dots[step-1].classList.remove('done');
}

async function generar(){
  try {
    const { turno } = await DigiturnoAPI.generarTurno({
      sede_id: sedeId, servicio_id: svcSeleccionado.id, prioridad,
      nombre_cliente: document.getElementById('fNombre').value.trim(),
      cedula: document.getElementById('fCedula').value.trim(),
      telefono: document.getElementById('fTelefono').value.trim()
    });
    turnoId = turno.ROWID;
    document.getElementById('step'+step).classList.remove('active');
    document.getElementById('step5').classList.add('active');
    document.getElementById('tNum').textContent = turno.numero_turno;
    document.getElementById('tSvc').textContent = turno.servicio_nombre || svcSeleccionado.nombre;
    document.getElementById('tNombre').textContent = document.getElementById('fNombre').value;
    document.getElementById('tCedula').textContent = 'Cedula: '+document.getElementById('fCedula').value;
    const est = turno.tiempo_estimado_min || (turno.posicion_en_cola||1)*5;
    document.getElementById('tWait').textContent = `Espera estimada: ~${est} min`;
    document.getElementById('tPos').textContent = `${turno.posicion_en_cola||1} persona(s) delante`;
    prevPos = turno.posicion_en_cola||1;
    startPolling();
  } catch(e){ alert('Error: '+e.message); }
}

function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  document.getElementById('bellBtn').classList.add('has-notifs');
  pollTimer = setInterval(pollTurno, 3000);
}

async function pollTurno(){
  if(!turnoId) return;
  try {
    const { turno } = await DigiturnoAPI.obtenerMiTurno(turnoId);
    if(!turno) return;
    const pos = turno.posicion_en_cola;
    const estado = turno.estado;

    document.getElementById('tPos').textContent = estado==='espera' ? `${pos} persona(s) delante` : estado==='llamado'||estado==='en_atencion' ? 'Es tu turno — Modulo '+turno.agente_modulo : estado;

    if(estado==='espera' && pos<=3 && (prevPos===null||prevPos>3)){
      addNotif('Casi es tu turno. Quedan '+pos+' persona(s) delante.', false);
    }
    if(estado==='espera' && pos===0 && prevPos!==0){
      addNotif('Eres el siguiente en la fila.', true);
    }
    if((estado==='llamado'||estado==='en_atencion') && prevPos!==0){
      addNotif('ES TU TURNO — Dirigete al modulo '+(turno.agente_modulo||''), true);
      playDing();
    }
    if(['finalizado','no_se_presento'].includes(estado)){
      clearInterval(pollTimer);
    }
    prevPos = pos;
  } catch(e){ /* silencioso */ }
}

function addNotif(msg, urgent){
  notifs.unshift({ msg, urgent, time: new Date().toLocaleTimeString('es') });
  if(notifs.length>10) notifs.pop();
  document.getElementById('bellCount').textContent = notifs.length;
  renderNotifs();
}

function renderNotifs(){
  document.getElementById('notifPanel').innerHTML = notifs.length===0 ? '<div class="notif-item" style="color:var(--muted)">Sin notificaciones</div>' :
    notifs.map(n=>`<div class="notif-item ${n.urgent?'urgent':''}"><div>${n.msg}</div><div class="notif-time">${n.time}</div></div>`).join('');
}

function toggleNotifPanel(){
  document.getElementById('notifPanel').classList.toggle('open');
}

function playDing(){
  try {
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.frequency.value = 880; gain.gain.value = 0.3;
    osc.start(); gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.8);
    osc.stop(ctx.currentTime+0.8);
  } catch(e){}
}

function resetApp(){
  step=1; prioridad='ninguna'; svcSeleccionado=null; turnoId=null; notifs=[]; prevPos=null;
  if(pollTimer) clearInterval(pollTimer);
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById('step1').classList.add('active');
  document.querySelectorAll('.dot').forEach((d,i)=>{ d.classList.remove('active','done'); if(i===0) d.classList.add('active'); });
  document.querySelectorAll('.prio-item').forEach(el=>el.classList.remove('selected'));
  document.getElementById('p-none').classList.add('selected');
  document.getElementById('fNombre').value='';
  document.getElementById('fCedula').value='';
  document.getElementById('fTelefono').value='';
  document.getElementById('bellBtn').classList.remove('has-notifs');
  document.getElementById('bellCount').textContent='0';
  document.getElementById('notifPanel').classList.remove('open');
  renderSvcs();
}

document.addEventListener('click', e => {
  const panel = document.getElementById('notifPanel');
  const bell = document.getElementById('bellBtn');
  if(!panel.contains(e.target) && !bell.contains(e.target)) panel.classList.remove('open');
});
</script>
</body>
</html>
