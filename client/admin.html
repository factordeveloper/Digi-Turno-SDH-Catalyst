<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Administrativo â€” DigiTurno</title>
  <link rel="stylesheet" href="main.css" />
  <style>
    .form-row { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem; align-items: flex-end; }
    .form-row > * { flex: 1; min-width: 140px; }
    .form-group { display: flex; flex-direction: column; gap: 0.3rem; }
    .form-group label { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }
    .act-col { display: flex; gap: 0.4rem; justify-content: flex-end; }
    .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 0.3rem; }
    .status-dot.on { background: var(--success); }
    .status-dot.off { background: var(--border); }
    .checkbox-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 10px; padding: 0.75rem; }
    .cb-item { display: flex; align-items: center; gap: 0.6rem; padding: 0.3rem 0; }
    .cb-item input { width: 16px; height: 16px; }
    .report-table-wrap { overflow-x: auto; margin-top: 1rem; }
    .report-table { font-size: 0.8rem; }
    .report-table th { font-size: 0.7rem; white-space: nowrap; }
    .report-table td { white-space: nowrap; }
  </style>
</head>
<body>
  <div class="screen-overlay" id="loadingOverlay">
    <div style="text-align:center"><div class="spinner"></div><p style="color:var(--text-muted)">Verificando sesion...</p></div>
  </div>
  <div class="screen-overlay hidden" id="authScreen">
    <div class="auth-card">
      <div class="auth-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.4-6.4l-1.4 1.4M7 17l-1.4 1.4m12.8 0L17 17M7 7L5.6 5.6"/></svg></div>
      <h2>Panel Administrativo</h2>
      <p>Solo administradores pueden acceder a este panel.</p>
      <div id="authError" style="color:#ef4444;padding:0.5rem;background:#fef2f2;border-radius:8px;margin-bottom:1rem;display:none;font-size:0.85rem;"></div>
      <button class="btn btn-primary" style="width:100%;padding:0.9rem;" onclick="DigiturnoAPI.redirectToLogin()">Iniciar sesion</button>
      <a href="index.html" style="display:block;margin-top:1rem;color:var(--text-muted);text-decoration:none;font-size:0.85rem;">Volver al inicio</a>
    </div>
  </div>

  <!-- Modal: Crear/Editar Sede -->
  <div class="modal-overlay hidden" id="modalSede">
    <div class="modal-box">
      <h2 id="modalSedeTitle">Nueva Sede</h2>
      <input type="hidden" id="sedeEditId">
      <div class="form-group" style="margin-bottom:1rem"><label>Nombre</label><input type="text" id="sedeNombre" placeholder="Nombre de la sede"></div>
      <div class="form-group" style="margin-bottom:1rem"><label>Direccion</label><input type="text" id="sedeDireccion" placeholder="Direccion"></div>
      <div style="display:flex;gap:0.75rem;margin-top:1rem">
        <button class="btn btn-primary" onclick="guardarSede()">Guardar</button>
        <button class="btn btn-outline" onclick="cerrarModal('modalSede')">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Crear Agente -->
  <div class="modal-overlay hidden" id="modalAgente">
    <div class="modal-box">
      <h2>Nuevo Agente</h2>
      <div class="form-group" style="margin-bottom:1rem"><label>Usuario Catalyst</label><select id="agCatalystUser"><option value="">Seleccione...</option></select></div>
      <div class="form-group" style="margin-bottom:1rem"><label>Nombre</label><input type="text" id="agNombre" placeholder="Nombre completo"></div>
      <div class="form-group" style="margin-bottom:1rem"><label>Email</label><input type="email" id="agEmail" placeholder="email@ejemplo.com"></div>
      <div class="form-row">
        <div class="form-group"><label>Sede</label><select id="agSede"><option value="">Seleccione...</option></select></div>
        <div class="form-group"><label>Rol</label><select id="agRol"><option value="agente">Agente</option><option value="admin">Admin</option></select></div>
        <div class="form-group"><label>Modulo</label><input type="text" id="agModulo" value="1" placeholder="1"></div>
      </div>
      <div style="display:flex;gap:0.75rem;margin-top:1rem">
        <button class="btn btn-primary" onclick="guardarAgente()">Crear</button>
        <button class="btn btn-outline" onclick="cerrarModal('modalAgente')">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Asignar Servicios -->
  <div class="modal-overlay hidden" id="modalSvcs">
    <div class="modal-box">
      <h2>Asignar Servicios</h2>
      <p style="color:var(--text-muted);margin-bottom:1rem">Agente: <strong id="svcAgenteName"></strong></p>
      <div class="checkbox-list" id="svcCheckList"></div>
      <div style="display:flex;gap:0.75rem;margin-top:1rem">
        <button class="btn btn-primary" onclick="guardarSvcs()">Guardar</button>
        <button class="btn btn-outline" onclick="cerrarModal('modalSvcs')">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="mainContent" class="hidden">
    <div class="user-bar">
      <div class="user-info">
        <div class="user-avatar"><img id="userPhoto" src="" alt=""/></div>
        <div>
          <div class="user-name" id="userName">Admin</div>
          <div class="user-email" id="userEmail"></div>
          <span class="badge badge-admin">Administrador</span>
        </div>
      </div>
      <button class="btn btn-outline btn-sm" onclick="DigiturnoAPI.logout()">Cerrar sesion</button>
    </div>

    <div class="container">
      <h1>Panel Administrativo</h1>
      <div class="tabs-bar">
        <button class="tab-btn active" onclick="tabTo('dashboard',this)">Dashboard</button>
        <button class="tab-btn" onclick="tabTo('sedes',this)">Sedes</button>
        <button class="tab-btn" onclick="tabTo('servicios',this)">Servicios</button>
        <button class="tab-btn" onclick="tabTo('agentes',this)">Agentes</button>
        <button class="tab-btn" onclick="tabTo('reportes',this)">Reportes</button>
      </div>

      <!-- Dashboard -->
      <div class="tab-content active" id="tab-dashboard">
        <div class="form-row" style="margin-bottom:1rem">
          <div class="form-group"><label>Sede</label><select id="dashSede" onchange="loadDashboard()"><option value="">Todas</option></select></div>
          <button class="btn btn-primary btn-sm" onclick="loadDashboard()">Actualizar</button>
        </div>
        <div id="dashKPIs"></div>
        <div id="dashServices" style="margin-top:1rem"></div>
        <div id="dashAgents" style="margin-top:1rem"></div>
      </div>

      <!-- Sedes -->
      <div class="tab-content" id="tab-sedes">
        <button class="btn btn-primary btn-sm" style="margin-bottom:1rem" onclick="abrirModalSede()">+ Nueva Sede</button>
        <div id="sedesTable"></div>
      </div>

      <!-- Servicios -->
      <div class="tab-content" id="tab-servicios">
        <div class="form-row" style="margin-bottom:1rem">
          <div class="form-group"><label>Nombre</label><input type="text" id="newSvcNombre" placeholder="Nombre del servicio"></div>
          <button class="btn btn-primary btn-sm" onclick="crearSvc()">Crear servicio</button>
        </div>
        <div id="svcsTable"></div>
      </div>

      <!-- Agentes -->
      <div class="tab-content" id="tab-agentes">
        <button class="btn btn-primary btn-sm" style="margin-bottom:1rem" onclick="abrirModalAgente()">+ Nuevo Agente</button>
        <div id="agentesTable"></div>
      </div>

      <!-- Reportes -->
      <div class="tab-content" id="tab-reportes">
        <div class="card" style="margin-bottom:1rem">
          <div class="form-row">
            <div class="form-group"><label>Fecha inicio</label><input type="date" id="repFI"></div>
            <div class="form-group"><label>Fecha fin</label><input type="date" id="repFF"></div>
            <div class="form-group"><label>Sede</label><select id="repSede"><option value="">Todas</option></select></div>
            <div class="form-group"><label>Servicio</label><select id="repSvc"><option value="">Todos</option></select></div>
            <div class="form-group"><label>Agente</label><select id="repAg"><option value="">Todos</option></select></div>
          </div>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
            <button class="btn btn-primary btn-sm" onclick="loadReportes()">Buscar</button>
            <button class="btn btn-accent btn-sm" onclick="exportCSV()">Exportar CSV</button>
          </div>
        </div>
        <div id="reportResults"></div>
      </div>

      <div id="msg" style="display:none;margin-top:1rem;"></div>
    </div>
  </div>

  <script src="https://static.zohocdn.com/catalyst/sdk/js/4.0.0/catalystWebSDK.js"></script>
  <script src="/__catalyst/sdk/init.js"></script>
  <script src="main.js"></script>
  <script>
    let usuario=null, sedesData=[], svcsData=[], agentesData=[], catalystUsers=[], svcAssignTarget=null;
    const hoy = new Date().toISOString().slice(0,10);

    function showMsg(txt, ok){
      const el=document.getElementById('msg');
      el.className = ok ? 'success-msg' : 'error-msg';
      el.textContent=txt; el.style.display='block';
      setTimeout(()=>{el.style.display='none';},4000);
    }

    function tabTo(name, btn){
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-'+name).classList.add('active');
    }

    function cerrarModal(id){ document.getElementById(id).classList.add('hidden'); }

    async function init(){
      try {
        const {usuario:u} = await DigiturnoAPI.verificarSesion();
        if(u.rol!=='admin'){ showAuth('Acceso solo para administradores.'); return; }
        usuario=u; showPanel();
      } catch(e){ showAuth(); }
    }

    function showAuth(msg){
      document.getElementById('loadingOverlay').classList.add('hidden');
      document.getElementById('authScreen').classList.remove('hidden');
      if(msg){const e=document.getElementById('authError');e.textContent=msg;e.style.display='block';}
    }

    function showPanel(){
      document.getElementById('loadingOverlay').classList.add('hidden');
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      const n=usuario.nombre||'Admin';
      document.getElementById('userPhoto').src=`https://ui-avatars.com/api/?name=${encodeURIComponent(n)}&background=E2072D&color=fff&size=80&bold=true`;
      document.getElementById('userName').textContent=n;
      document.getElementById('userEmail').textContent=usuario.email||'';
      document.getElementById('repFI').value=hoy;
      document.getElementById('repFF').value=hoy;
      loadAll();
    }

    async function loadAll(){
      await Promise.all([loadSedes(), loadSvcs(), loadAgentes()]);
      populateFilters();
      loadDashboard();
    }

    function populateFilters(){
      const opts = s => sedesData.filter(x=>x.activo).map(x=>`<option value="${x.ROWID}">${x.nombre}</option>`).join('');
      ['dashSede','repSede','agSede'].forEach(id=>{
        const el=document.getElementById(id); if(!el) return;
        const first = id==='agSede'?'<option value="">Seleccione...</option>':'<option value="">Todas</option>';
        el.innerHTML = first + opts();
      });
      const svcOpts = svcsData.filter(s=>s.activo!==false).map(s=>`<option value="${s.ROWID}">${s.nombre}</option>`).join('');
      document.getElementById('repSvc').innerHTML = '<option value="">Todos</option>'+svcOpts;
      const agOpts = agentesData.map(a=>`<option value="${a.ROWID}">${a.nombre}</option>`).join('');
      document.getElementById('repAg').innerHTML = '<option value="">Todos</option>'+agOpts;
    }

    // ===== DASHBOARD =====
    async function loadDashboard(){
      try {
        const sede = document.getElementById('dashSede').value;
        const d = await DigiturnoAPI.getDashboard(sede||undefined);
        const r = d.resumen;
        document.getElementById('dashKPIs').innerHTML = `<div class="kpi-grid">
          <div class="kpi-card"><div class="kpi-value" style="color:var(--primary)">${r.total_turnos}</div><div class="kpi-label">Total turnos</div></div>
          <div class="kpi-card"><div class="kpi-value" style="color:var(--accent)">${r.en_espera}</div><div class="kpi-label">En espera</div></div>
          <div class="kpi-card"><div class="kpi-value" style="color:#3b82f6">${r.en_atencion+r.llamados}</div><div class="kpi-label">Activos</div></div>
          <div class="kpi-card"><div class="kpi-value" style="color:var(--success)">${r.finalizados}</div><div class="kpi-label">Finalizados</div></div>
          <div class="kpi-card"><div class="kpi-value" style="color:#6b7280">${r.no_se_presento}</div><div class="kpi-label">No presentados</div></div>
          <div class="kpi-card"><div class="kpi-value" style="color:var(--success)">${r.agentes_activos}</div><div class="kpi-label">Agentes activos</div></div>
          <div class="kpi-card"><div class="kpi-value" style="color:var(--accent)">${formatTime(r.promedio_espera_seg)}</div><div class="kpi-label">Prom. espera</div></div>
          <div class="kpi-card"><div class="kpi-value" style="color:var(--primary)">${formatTime(r.promedio_atencion_seg)}</div><div class="kpi-label">Prom. atencion</div></div>
        </div>`;
        document.getElementById('dashServices').innerHTML = (d.por_servicio||[]).length===0?'':
          `<div class="card"><h2 style="font-size:1rem;margin-bottom:0.75rem">Por servicio</h2><table><tr><th>Servicio</th><th>Espera</th><th>Activos</th><th>Finalizados</th><th>No present.</th><th>Total</th></tr>${d.por_servicio.map(s=>`<tr><td><strong>${s.nombre}</strong></td><td>${s.en_espera}</td><td>${s.llamados+s.en_atencion}</td><td>${s.finalizados}</td><td>${s.no_se_presento}</td><td>${s.total}</td></tr>`).join('')}</table></div>`;
        document.getElementById('dashAgents').innerHTML = (d.agentes||[]).length===0?'':
          `<div class="card"><h2 style="font-size:1rem;margin-bottom:0.75rem">Agentes conectados</h2>${d.agentes.map(a=>`<div style="display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid var(--border)"><span><span class="status-dot on"></span>${a.nombre}</span><span class="badge badge-modulo">Mod. ${a.modulo_atencion||'-'}</span></div>`).join('')}</div>`;
      } catch(e){ showMsg(e.message,false); }
    }

    // ===== SEDES =====
    async function loadSedes(){
      try {
        const {sedes}=await DigiturnoAPI.listarSedes();
        sedesData=sedes||[];
        document.getElementById('sedesTable').innerHTML = sedesData.length===0?'<p style="color:var(--text-muted)">No hay sedes.</p>':
          `<div class="card" style="padding:0;overflow:hidden"><table><tr><th>Nombre</th><th>Direccion</th><th style="text-align:center">Activa</th><th></th></tr>${sedesData.map(s=>`<tr><td><strong>${s.nombre}</strong></td><td>${s.direccion||'-'}</td><td style="text-align:center">${s.activo?'<span style="color:var(--success)">Si</span>':'<span style="color:var(--text-muted)">No</span>'}</td><td class="act-col"><button class="btn btn-outline btn-sm" onclick="editSede('${s.ROWID}')">Editar</button>${s.activo?`<button class="btn btn-danger btn-sm" onclick="delSede('${s.ROWID}')">Desact.</button>`:''}</td></tr>`).join('')}</table></div>`;
      } catch(e){ showMsg(e.message,false); }
    }

    function abrirModalSede(){ document.getElementById('sedeEditId').value=''; document.getElementById('sedeNombre').value=''; document.getElementById('sedeDireccion').value=''; document.getElementById('modalSedeTitle').textContent='Nueva Sede'; document.getElementById('modalSede').classList.remove('hidden'); }

    function editSede(id){
      const s=sedesData.find(x=>x.ROWID===id); if(!s) return;
      document.getElementById('sedeEditId').value=id;
      document.getElementById('sedeNombre').value=s.nombre||'';
      document.getElementById('sedeDireccion').value=s.direccion||'';
      document.getElementById('modalSedeTitle').textContent='Editar Sede';
      document.getElementById('modalSede').classList.remove('hidden');
    }

    async function guardarSede(){
      const id=document.getElementById('sedeEditId').value;
      const nombre=document.getElementById('sedeNombre').value.trim();
      const direccion=document.getElementById('sedeDireccion').value.trim();
      if(!nombre){showMsg('Nombre requerido',false);return;}
      try {
        if(id) await DigiturnoAPI.actualizarSede(id,{nombre,direccion});
        else await DigiturnoAPI.crearSede({nombre,direccion});
        cerrarModal('modalSede'); showMsg(id?'Sede actualizada':'Sede creada',true);
        await loadSedes(); populateFilters();
      } catch(e){showMsg(e.message,false);}
    }

    async function delSede(id){
      if(!confirm('Desactivar esta sede?')) return;
      try { await DigiturnoAPI.eliminarSede(id); showMsg('Sede desactivada',true); await loadSedes(); populateFilters(); } catch(e){showMsg(e.message,false);}
    }

    // ===== SERVICIOS =====
    async function loadSvcs(){
      try {
        const {servicios}=await DigiturnoAPI.listarServicios();
        svcsData=servicios||[];
        document.getElementById('svcsTable').innerHTML = svcsData.length===0?'<p style="color:var(--text-muted)">No hay servicios.</p>':
          `<div class="card" style="padding:0;overflow:hidden"><table><tr><th>Nombre</th><th style="text-align:center">Activo</th><th></th></tr>${svcsData.map(s=>`<tr><td><strong>${s.nombre}</strong></td><td style="text-align:center">${s.activo?'<span style="color:var(--success)">Si</span>':'No'}</td><td class="act-col">${s.activo?`<button class="btn btn-danger btn-sm" onclick="delSvc('${s.ROWID}')">Desact.</button>`:''}</td></tr>`).join('')}</table></div>`;
      } catch(e){showMsg(e.message,false);}
    }

    async function crearSvc(){
      const nombre=document.getElementById('newSvcNombre').value.trim();
      if(!nombre){showMsg('Nombre requerido',false);return;}
      try { await DigiturnoAPI.crearServicio({nombre}); document.getElementById('newSvcNombre').value=''; showMsg('Servicio creado',true); await loadSvcs(); populateFilters(); }
      catch(e){showMsg(e.message,false);}
    }

    async function delSvc(id){
      if(!confirm('Desactivar este servicio?')) return;
      try { await DigiturnoAPI.eliminarServicio(id); showMsg('Servicio desactivado',true); await loadSvcs(); populateFilters(); } catch(e){showMsg(e.message,false);}
    }

    // ===== AGENTES =====
    async function loadAgentes(){
      try {
        const {usuarios}=await DigiturnoAPI.listarUsuarios();
        agentesData=usuarios||[];
        const sedeMap={}; sedesData.forEach(s=>{sedeMap[s.ROWID]=s.nombre;});
        document.getElementById('agentesTable').innerHTML = agentesData.length===0?'<p style="color:var(--text-muted)">No hay agentes.</p>':
          `<div class="card" style="padding:0;overflow:hidden"><table><tr><th>Nombre</th><th>Email</th><th>Sede</th><th style="text-align:center">Rol</th><th style="text-align:center">Modulo</th><th style="text-align:center">Estado</th><th></th></tr>${agentesData.map(a=>`<tr><td><strong>${a.nombre}</strong></td><td>${a.email||'-'}</td><td>${sedeMap[a.sede_id]||'-'}</td><td style="text-align:center">${a.rol==='admin'?'<span style="color:var(--primary);font-weight:600">Admin</span>':'Agente'}</td><td style="text-align:center">${a.modulo_atencion||'-'}</td><td style="text-align:center"><span class="status-dot ${a.estado==='activo'?'on':'off'}"></span>${a.estado||'desc.'}</td><td class="act-col"><button class="btn btn-accent btn-sm" onclick="abrirSvcs('${a.ROWID}','${a.nombre}')">Servicios</button>${a.activo?`<button class="btn btn-danger btn-sm" onclick="delAgente('${a.ROWID}')">Desact.</button>`:''}</td></tr>`).join('')}</table></div>`;
      } catch(e){showMsg(e.message,false);}
    }

    async function abrirModalAgente(){
      try {
        const {usuarios}=await DigiturnoAPI.listarUsuariosCatalyst();
        catalystUsers=usuarios||[];
        const sel=document.getElementById('agCatalystUser');
        sel.innerHTML='<option value="">Seleccione...</option>'+catalystUsers.map(u=>`<option value="${u.user_id}" data-name="${u.nombre}" data-email="${u.email}">${u.nombre} (${u.email})</option>`).join('');
        sel.onchange=function(){
          const opt=this.selectedOptions[0];
          if(opt&&opt.dataset.name){document.getElementById('agNombre').value=opt.dataset.name;document.getElementById('agEmail').value=opt.dataset.email||'';}
        };
        document.getElementById('agNombre').value='';
        document.getElementById('agEmail').value='';
        document.getElementById('agModulo').value='1';
        document.getElementById('agRol').value='agente';
        document.getElementById('modalAgente').classList.remove('hidden');
      } catch(e){showMsg(e.message,false);}
    }

    async function guardarAgente(){
      const catalyst_user_id=document.getElementById('agCatalystUser').value;
      const nombre=document.getElementById('agNombre').value.trim();
      const email=document.getElementById('agEmail').value.trim();
      const sede_id=document.getElementById('agSede').value;
      const rol=document.getElementById('agRol').value;
      const modulo_atencion=document.getElementById('agModulo').value.trim()||'1';
      if(!catalyst_user_id){showMsg('Seleccione un usuario Catalyst',false);return;}
      if(!nombre){showMsg('Nombre requerido',false);return;}
      try {
        await DigiturnoAPI.crearUsuario({catalyst_user_id,nombre,email,sede_id,rol,modulo_atencion});
        cerrarModal('modalAgente'); showMsg('Agente creado',true);
        await loadAgentes(); populateFilters();
      } catch(e){showMsg(e.message,false);}
    }

    async function delAgente(id){
      if(!confirm('Desactivar este agente?')) return;
      try { await DigiturnoAPI.eliminarUsuario(id); showMsg('Agente desactivado',true); await loadAgentes(); populateFilters(); } catch(e){showMsg(e.message,false);}
    }

    function abrirSvcs(agenteId, nombre){
      svcAssignTarget=agenteId;
      document.getElementById('svcAgenteName').textContent=nombre;
      const ag=agentesData.find(a=>a.ROWID===agenteId);
      const asignados=ag?ag.servicios_asignados||[]:[];
      document.getElementById('svcCheckList').innerHTML = svcsData.filter(s=>s.activo!==false).map(s=>`<div class="cb-item"><input type="checkbox" id="sc-${s.ROWID}" value="${s.ROWID}" ${asignados.includes(s.ROWID)?'checked':''}><label for="sc-${s.ROWID}">${s.nombre}</label></div>`).join('');
      document.getElementById('modalSvcs').classList.remove('hidden');
    }

    async function guardarSvcs(){
      if(!svcAssignTarget) return;
      const checks=document.querySelectorAll('#svcCheckList input:checked');
      const servicios=Array.from(checks).map(c=>c.value);
      try { await DigiturnoAPI.asignarServicios(svcAssignTarget,servicios); cerrarModal('modalSvcs'); showMsg('Servicios asignados',true); await loadAgentes(); }
      catch(e){showMsg(e.message,false);}
    }

    // ===== REPORTES =====
    async function loadReportes(){
      const params={};
      const fi=document.getElementById('repFI').value; if(fi) params.fecha_inicio=fi;
      const ff=document.getElementById('repFF').value; if(ff) params.fecha_fin=ff;
      const sede=document.getElementById('repSede').value; if(sede) params.sede_id=sede;
      const svc=document.getElementById('repSvc').value; if(svc) params.servicio_id=svc;
      const ag=document.getElementById('repAg').value; if(ag) params.agente_id=ag;
      try {
        const {reportes,total}=await DigiturnoAPI.getReportes(params);
        document.getElementById('reportResults').innerHTML = reportes.length===0?'<p style="color:var(--text-muted);padding:1rem">Sin resultados.</p>':
          `<p style="margin-bottom:0.5rem;font-size:0.85rem;color:var(--text-muted)">${total} registro(s)</p><div class="report-table-wrap"><table class="report-table"><tr><th>Fecha</th><th>Turno</th><th>Sede</th><th>Servicio</th><th>Agente</th><th>Estado</th><th>Cliente</th><th>Generado</th><th>Llamado</th><th>Inicio</th><th>Fin</th><th>Espera</th><th>Atencion</th><th>Llamadas</th></tr>${reportes.map(r=>`<tr><td>${r.fecha_turno}</td><td><strong>${r.numero_turno}</strong></td><td>${r.sede}</td><td>${r.servicio}</td><td>${r.agente}</td><td>${r.estado}</td><td>${r.nombre_cliente}</td><td>${r.hora_generado}</td><td>${r.hora_llamado||'-'}</td><td>${r.hora_inicio_atencion||'-'}</td><td>${r.hora_fin_atencion||'-'}</td><td>${formatTime(r.tiempo_espera_seg)}</td><td>${formatTime(r.tiempo_atencion_seg)}</td><td>${r.llamadas}</td></tr>`).join('')}</table></div>`;
      } catch(e){showMsg(e.message,false);}
    }

    async function exportCSV(){
      const params={};
      const fi=document.getElementById('repFI').value; if(fi) params.fecha_inicio=fi;
      const ff=document.getElementById('repFF').value; if(ff) params.fecha_fin=ff;
      const sede=document.getElementById('repSede').value; if(sede) params.sede_id=sede;
      const svc=document.getElementById('repSvc').value; if(svc) params.servicio_id=svc;
      const ag=document.getElementById('repAg').value; if(ag) params.agente_id=ag;
      try {
        const csv=await DigiturnoAPI.getReportesCSV(params);
        downloadCSV(csv, `reporte_${fi||hoy}.csv`);
        showMsg('CSV exportado',true);
      } catch(e){showMsg(e.message,false);}
    }

    init();
  </script>
</body>
</html>
